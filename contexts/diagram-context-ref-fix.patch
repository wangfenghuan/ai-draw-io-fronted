diff --git a/contexts/diagram-context.tsx b/contexts/diagram-context.tsx
index 1234567..abcdefg 100644
--- a/contexts/diagram-context.tsx
+++ b/contexts/diagram-context.tsx
@@ -64,6 +64,16 @@ export function DiagramProvider({ children }: { children: React.ReactNode })
     const [collaborationIsReadOnly, setCollaborationIsReadOnly] =
         useState(false)
     const isUpdatingFromRemoteRef = useRef(false) // 防止循环更新
+
+    // 使用 ref 存储最新的协作状态，避免闭包陷阱
+    const collaborationStateRef = useRef({
+        enabled: collaborationEnabled,
+        connected: false,
+    })
+
+    // 更新 ref 当状态变化时
+    useEffect(() => {
+        collaborationStateRef.current.enabled = collaborationEnabled
+    }, [collaborationEnabled])

     // 初始化 Yjs 协作 Hook
     const {
@@ -105,6 +115,11 @@ export function DiagramProvider({ children }: { children: React.ReactNode })
         },
     })

+    // 更新 ref 当连接状态变化时
+    useEffect(() => {
+        collaborationStateRef.current.connected = collaborationConnected
+    }, [collaborationConnected])
+
     const onDrawioLoad = () => {
         // Only set ready state once to prevent infinite loops
         if (hasCalledOnLoadRef.current) return
@@ -234,16 +249,16 @@ export function DiagramProvider({ children }: { children: React.ReactNode })
         setLatestSvg(data.data)

         // Yjs 协作：推送本地更新到服务器（如果不是远程更新触发的）
+        // 使用 ref.current 读取最新状态，避免闭包陷阱
+        const currentEnabled = collaborationStateRef.current.enabled
+        const currentConnected = collaborationStateRef.current.connected
+
         console.log("[handleDiagramExport] Checking if should push to Yjs:", {
-            collaborationEnabled,
-            collaborationConnected,
+            collaborationEnabled: currentEnabled,
+            collaborationConnected: currentConnected,
             isUpdatingFromRemote: isUpdatingFromRemoteRef.current,
             xmlLength: extractedXML?.length,
         })

-        if (
-            collaborationEnabled &&
-            collaborationConnected &&
+        if (currentEnabled && currentConnected &&
             !isUpdatingFromRemoteRef.current
         ) {
             console.log(
@@ -256,7 +271,7 @@ export function DiagramProvider({ children }: { children: React.ReactNode })
             } else {
                 console.log(
                     "[DiagramContext] Skipping Yjs push - collaboration disabled or remote update in progress",
-                )
+                )
             }

             // Only add to history if this was a user-initiated export
@@ -281,7 +296,7 @@ export function DiagramProvider({ children }: { children: React.ReactNode })
             }
         },
         [
-            collaborationEnabled,
-            collaborationConnected,
+            pushUpdate,
+        ], // 只依赖 pushUpdate，状态从 ref 读取
     )

